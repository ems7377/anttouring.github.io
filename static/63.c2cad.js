webpackJsonp([63],{HwN1:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=g(r("trpn")),n=g(r("IidI")),a=g(r("1cZb")),o=g(r("PoSO")),i=g(r("NJOH")),l=g(r("37+n")),p=g(r("uuhB")),u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},c=function(){function e(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,r,s){return r&&e(t.prototype,r),s&&e(t,s),t}}();r("Op6J"),r("1uA9"),r("YaoS"),r("BTAY"),r("mKHw"),r("8QNH"),r("TZP0");var d=r("U7vG"),f=g(d),h=r("4n+p"),m=g(r("mtWM"));function g(e){return e&&e.__esModule?e:{default:e}}var y=p.default.TextArea,E=l.default.Item,R=i.default.Option,v=o.default.Group,b=0,w=2e3,S="0000000",I={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:20}}},O={wrapperCol:{xs:{span:24,offset:0},sm:{span:20,offset:4}}},C=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.getRoleWithRoles=function(e,t){r.setState({loading:!0});var s=[];(0,m.default)("/api-message/message-role-list?app="+e+"&role="+t).then(function(e){return e.data}).then(function(e){r.setState({configRoles:e,loading:!1}),s=e;var t=e.map(function(e){return(0,m.default)({url:"/api-user/enterprises/"+r.props.enterprises[r.props.currentEnterprise].id+"/roles/"+e+"/users?username=&belongs=true&page="+b+"&size="+w,method:"GET"})});return Promise.all(t)}).then(function(e){var t=new Map,n=[];e.forEach(function(e,r){t.set(s[r],e.data.content),e.data.content.forEach(function(e){-1===n.indexOf(e)&&n.push(e)})}),r.setState({roleUserMap:t,users:n})}).catch(function(e){a.default.error("没有配置权限"),r.setState({loading:!1})})},r.getRoleList=function(e){var t=[];(0,m.default)("/api-user/enterprises/"+e+"/roles?page=0&size=1000").then(function(e){t=e.data,r.setState({roleList:t.content})}).catch(function(e){a.default.error("暂无角色列表"),r.setState({loading:!1})})},r.onRecipientGroupsChange=function(e){r.setState({selectedRoles:e});var t=r.state.selectedUsers.slice(0);e.forEach(function(e){var s=[],n=!0,a=!1,o=undefined;try{for(var i,l=r.state.roleUserMap.keys()[Symbol.iterator]();!(n=(i=l.next()).done);n=!0){var p=i.value;p===e&&(s=r.state.roleUserMap.get(p))}}catch(e){a=!0,o=e}finally{try{!n&&l.return&&l.return()}finally{if(a)throw o}}s.forEach(function(e){-1===t.indexOf(e.id)&&t.push(e.id)})}),r.setState({selectedUsers:t}),r.props.form.setFieldsValue({recipients:t})},r.onRecipientsChange=function(e){r.setState({selectedUsers:e});var t=[];Array.from(r.state.roleUserMap.values()).forEach(function(r){var s=!1;r.forEach(function(t){-1!==e.indexOf(t.id)&&(s=!0)}),t.push(s)});var s=Array.from(r.state.roleUserMap.keys()),n=[];t.forEach(function(e,t){e&&n.push(s[t])});var a=r.state.selectedRoles.slice(0);a=a.filter(function(e){return-1!==n.indexOf(e)}),r.setState({selectedRoles:a}),r.props.form.setFieldsValue({recipientGroups:a})},r.getMessageTypeList=function(e,t){(0,m.default)("/api-message/notificationTypes?appId="+e+"&name=&enterprise="+t+"&page=0&size=1000",{contentType:"application/json"}).then(function(e){r.setState({typeList:e.data.content})}).catch(function(e){a.default.error("暂无消息类型列表"),r.setState({loading:!1})})},r.handleSubmit=function(e){e.preventDefault(),r.props.form.validateFieldsAndScroll(function(e,t){e||(0,m.default)({url:"/api-message/notifications",method:"POST",data:{subject:t.subject,content:t.body,senderId:r.props.userId,senderName:r.props.userName,importance:t.importance,messageType:{id:t.type},appId:r.state.appId,enterpriseId:r.props.enterprises[r.props.currentEnterprise].id,receiverIds:t.recipients,receiverNames:t.recipients.map(function(e){var t=r.state.users.findIndex(function(t){return t.id===e});return t>=0?r.state.users[t].username:""}),hasDeleted:!1}}).then(function(e){a.default.success("消息发送成功"),r.props.form.resetFields(),r.props.onReturn()}).catch(function(e){a.default.error("消息发送失败")})})},r.state={loading:!1,roleList:[],configRoles:[],users:[],roleUserMap:new Map,selectedRoles:[],selectedUsers:[],appId:r.props.appList.length>0?r.props.appList[0].appId:"",typeList:[]},r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,d.Component),c(t,[{key:"componentDidMount",value:function(){this.props.enterprises[this.props.currentEnterprise]&&this.props.roles[this.props.currentRole]&&(this.getRoleList(this.props.enterprises[this.props.currentEnterprise].id),this.getMessageTypeList(this.state.appId,this.props.enterprises[this.props.currentEnterprise].id),this.props.roles[this.props.currentRole].code===S?this.getRoleWithRoles(this.state.appId,this.props.roles.filter(function(e){return e.code!==S}).map(function(e){return e.id})):this.getRoleWithRoles(this.state.appId,this.props.roles[this.props.currentRole].id))}},{key:"componentDidUpdate",value:function(e){!this.props.enterprises[this.props.currentEnterprise]||!this.props.roles[this.props.currentRole]||this.props.currentEnterprise===e.currentEnterprise&&this.props.enterprises===e.enterprises||this.props.currentRole===e.currentRole&&this.props.roles===e.roles||(this.getMessageTypeList(this.state.appId,this.props.enterprises[this.props.currentEnterprise].id),this.props.roles[this.props.currentRole].code===S?this.getRoleWithRoles(this.state.appId,this.props.roles.filter(function(e){return e.code!==S}).map(function(e){return e.id})):this.getRoleWithRoles(this.state.appId,this.props.roles[this.props.currentRole].id))}},{key:"render",value:function(){var e=this,t=this.props.form,r=t.getFieldDecorator,a=t.isFieldsTouched,c=[];this.state.selectedRoles.forEach(function(t){c=c.concat(e.state.roleUserMap.get(t))});var d=new Map;c.forEach(function(e){d.get(e.id)||d.set(e.id,e)});var h=Array.from(d.values());return f.default.createElement(s.default,{spinning:this.state.loading,size:"large"},f.default.createElement(l.default,{onSubmit:this.handleSubmit},f.default.createElement(E,u({},I,{label:"应用"}),r("appId",{initialValue:this.state.appId,rules:[{required:!0,message:"请选择应用"}]})(f.default.createElement(i.default,{style:{width:"100%"},allowClear:!0,showArrow:!1,showSearch:!0,onChange:function(t){e.setState({appId:t,selectedRoles:[],roleUserMap:new Map,selectedUsers:[]}),e.getMessageTypeList(t,e.props.enterprises[e.props.currentEnterprise].id),e.props.roles[e.props.currentRole].code===S?e.getRoleWithRoles(t,e.props.roles.filter(function(e){return e.code!==S}).map(function(e){return e.id})):e.getRoleWithRoles(t,e.props.roles[e.props.currentRole].id),e.props.form.resetFields(["recipientGroups","recipients","type"])}},this.props.appList.map(function(e){return f.default.createElement(R,{key:e.appId,value:e.appId},e.appName)})))),f.default.createElement(E,u({},I,{label:"收件群组"}),r("recipientGroups",{rules:[{required:!1,message:"请选择收件群组"}]})(f.default.createElement(i.default,{style:{width:"100%"},mode:"multiple",maxTagCount:5,allowClear:!0,showArrow:!1,showSearch:!0,onChange:this.onRecipientGroupsChange,placeholder:"可以选择群组进行添加相应群组的全部成员到收件人中"},this.state.roleList.filter(function(t){return-1!==e.state.configRoles.indexOf(t.id)}).map(function(e){return f.default.createElement(R,{key:e.id,value:e.id},e.name)})))),f.default.createElement(E,u({},I,{label:"收件人"}),r("recipients",{rules:[{required:!0,message:"请选择收件人"}]})(f.default.createElement(i.default,{style:{width:"100%"},mode:"multiple",maxTagCount:5,allowClear:!0,showArrow:!1,showSearch:!0,onChange:this.onRecipientsChange,placeholder:"选择收件人(必选，可以多选)"},h.map(function(e){return f.default.createElement(R,{key:e.id,value:e.id},e.username)})))),f.default.createElement(E,u({},I,{label:"类别"}),r("type",{rules:[{required:!0,message:"请选择消息类别"}]})(f.default.createElement(i.default,{style:{width:"100%"},allowClear:!0,showArrow:!1,placeholder:"选择消息类型"},this.state.typeList.map(function(e){return f.default.createElement(R,{key:e.id,value:e.id},e.name)})))),f.default.createElement(E,u({},I,{label:"标记为重要"}),r("importance",{rules:[{required:!0,message:"Please input your E-mail!"}],initialValue:"normal"})(f.default.createElement(v,null,f.default.createElement(o.default,{value:"importance"},"重要"),f.default.createElement(o.default,{value:"normal"},"常规")))),f.default.createElement(E,u({},I,{label:"主题"}),r("subject",{rules:[{required:!0,message:"请填写消息主题"}]})(f.default.createElement(p.default,null))),f.default.createElement(E,u({},I,{label:"内容"}),r("body",{rules:[{required:!0,message:"请填写消息内容"}]})(f.default.createElement(y,{rows:7}))),f.default.createElement(E,O,f.default.createElement(n.default,{type:"primary",htmlType:"submit",style:{marginRight:8}},"提交"),f.default.createElement(n.default,{onClick:function(){a()?confirm({title:"您有新增内容，确认返回？",okText:"返回",cancelText:"取消",onOk:function(){e.props.onReturn()},onCancel:function(){}}):e.props.onReturn()}},"取消"))))}}]),t}();t.default=(0,h.connect)(function(e){return u({},e.messageSent,{enterprises:e.userData.enterprises,currentEnterprise:e.userData.currentEnterprise,userId:e.authentication.userId,userName:e.authentication.username,roles:e.userData.roles,currentRole:e.userData.currentRole})},function(e,t){return{dispatch:e,update:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(t){e(update(t))}),onReturn:function(e){t.history.goBack()}}})(l.default.create()(C))}});